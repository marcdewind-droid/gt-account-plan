<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maki Account Intelligence Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --maki-purple:#5845C2; --maki-purple-dark:#4435a0; --maki-turquoise:#45FFC0; --maki-yellow:#E1FF00; --maki-black:#091010; --maki-grey-light:#F6F5EF; --maki-white:#FFFFFF; --radius:12px; --shadow:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04); --shadow-lg:0 10px 25px rgba(0,0,0,0.08); }
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:var(--maki-grey-light);color:var(--maki-black);min-height:100vh}
.topbar{background:var(--maki-black);color:white;padding:0 32px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-logo{display:flex;align-items:center;gap:12px}.topbar-logo svg{width:28px;height:28px}.topbar-logo span{font-weight:700;font-size:16px;letter-spacing:-0.5px}
.topbar-right{display:flex;align-items:center;gap:16px}.topbar-user{display:flex;align-items:center;gap:8px}
.topbar-user select{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:4px 8px;border-radius:6px;font-family:inherit;font-size:12px}
.topbar-badge{background:var(--maki-turquoise);color:var(--maki-black);font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}
.topbar-back{background:none;border:none;color:white;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:inherit;font-size:13px;opacity:0.7;transition:opacity 0.2s}.topbar-back:hover{opacity:1}
.portfolio{max-width:1200px;margin:0 auto;padding:40px 32px}.portfolio h1{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:4px}.portfolio .subtitle{color:#888;font-size:14px;margin-bottom:32px}
.account-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px}
.account-card{background:white;border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);cursor:pointer;transition:all 0.2s;border:2px solid transparent;position:relative;overflow:hidden}
.account-card:hover{box-shadow:var(--shadow-lg);border-color:var(--maki-purple);transform:translateY(-2px)}
.account-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.account-card h3{font-size:18px;font-weight:700;letter-spacing:-0.5px}
.account-card .stage-badge{font-size:10px;font-weight:600;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:0.5px}
.stage-expansion{background:rgba(88,69,194,0.1);color:var(--maki-purple)}.stage-prospect{background:rgba(245,158,11,0.1);color:#f59e0b}.stage-won{background:rgba(34,197,94,0.1);color:#22c55e}
.account-card .meta{display:flex;gap:16px;margin-bottom:16px}.account-card .meta-item{font-size:11px;color:#888}.account-card .meta-item strong{color:var(--maki-black);font-weight:600}
.account-card .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding-top:16px;border-top:1px solid rgba(0,0,0,0.04)}
.account-card .stat{text-align:center}.account-card .stat-value{font-size:20px;font-weight:700;color:var(--maki-purple)}.account-card .stat-label{font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:#888;margin-top:2px}
.add-account-card{background:white;border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);cursor:pointer;transition:all 0.2s;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;min-height:200px}
.add-account-card:hover{border-color:var(--maki-purple);background:rgba(88,69,194,0.02)}.add-account-inner{text-align:center;color:#888}.add-account-inner .plus{font-size:32px;color:var(--maki-purple);margin-bottom:8px}.add-account-inner p{font-size:13px}.account-view{display:none}.account-hero{background:linear-gradient(135deg,var(--maki-purple) 0%,#7B6BD6 100%);color:white;padding:32px}
.account-hero-inner{max-width:1200px;margin:0 auto}.account-hero h1{font-size:32px;font-weight:800;letter-spacing:-1px;margin-bottom:4px}
.account-hero .hero-meta{display:flex;gap:24px;font-size:13px;opacity:0.8;margin-top:8px}.account-hero .hero-meta span{display:flex;align-items:center;gap:4px}
.section-nav{background:white;border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:56px;z-index:90;overflow-x:auto}
.section-nav-inner{max-width:1200px;margin:0 auto;display:flex;gap:0;padding:0 32px}
.section-tab{padding:14px 16px;font-size:12px;font-weight:500;color:#888;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.2s}
.section-tab:hover{color:var(--maki-black)}.section-tab.active{color:var(--maki-purple);border-bottom-color:var(--maki-purple);font-weight:600}
.sections-container{max-width:1200px;margin:0 auto;padding:24px 32px}.section-panel{display:none}.section-panel.active{display:block}
.card{background:white;border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);margin-bottom:16px}
.card h2{font-size:16px;font-weight:700;letter-spacing:-0.3px;margin-bottom:16px;display:flex;align-items:center;gap:8px}.card h2 .icon{font-size:18px}
.research-item{padding:16px;border-radius:8px;background:var(--maki-grey-light);margin-bottom:8px;position:relative;transition:all 0.2s}
.research-item:hover{background:rgba(88,69,194,0.04)}.research-item.unread{border-left:3px solid var(--maki-purple)}
.research-category{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:2px 8px;border-radius:10px;display:inline-block;margin-bottom:6px}
.cat-news{background:rgba(59,130,246,0.1);color:#3b82f6}.cat-leadership{background:rgba(168,85,247,0.1);color:#a855f7}
.cat-jobs{background:rgba(34,197,94,0.1);color:#22c55e}.cat-financials{background:rgba(245,158,11,0.1);color:#f59e0b}
.cat-competitive{background:rgba(239,68,68,0.1);color:#ef4444}.cat-social{background:rgba(6,182,212,0.1);color:#06b6d4}
.research-title{font-size:14px;font-weight:600;margin-bottom:4px}.research-content{font-size:12px;color:#666;line-height:1.5;margin-bottom:6px}
.research-meta{font-size:10px;color:#aaa;display:flex;justify-content:space-between;align-items:center}
.research-score{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px}
.score-high{background:rgba(239,68,68,0.1);color:#ef4444}.score-medium{background:rgba(245,158,11,0.1);color:#f59e0b}.score-low{background:rgba(34,197,94,0.1);color:#22c55e}
table{width:100%;border-collapse:collapse}th{text-align:left;padding:10px 16px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#888;font-weight:600;background:var(--maki-grey-light)}
td{padding:10px 16px;border-bottom:1px solid rgba(0,0,0,0.04);font-size:13px}
.editable{outline:none;padding:2px 4px;border-radius:4px;transition:background 0.2s;min-width:40px}.editable:hover{background:rgba(88,69,194,0.04)}.editable:focus{background:rgba(88,69,194,0.08);box-shadow:0 0 0 2px rgba(88,69,194,0.2)}
.edit-select{border:1px solid #e5e5e5;border-radius:6px;padding:4px 8px;font-family:inherit;background:white;cursor:pointer}
.btn-add{padding:4px 12px;background:none;border:1px dashed #ccc;border-radius:4px;cursor:pointer;font-size:11px;color:#888;font-family:inherit;transition:all 0.2s}.btn-add:hover{border-color:var(--maki-purple);color:var(--maki-purple)}
.btn-delete{background:none;border:none;color:#ccc;cursor:pointer;font-size:16px;transition:color 0.2s}.btn-delete:hover{color:#ef4444}
.btn-primary{background:var(--maki-purple);color:white;border:none;padding:8px 16px;border-radius:6px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s}.btn-primary:hover{background:var(--maki-purple-dark)}
.status-badge{font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px;display:inline-block}
.status-active{background:rgba(34,197,94,0.1);color:#22c55e}.status-testing{background:rgba(245,158,11,0.1);color:#f59e0b}.status-planned{background:rgba(59,130,246,0.1);color:#3b82f6}.status-completed{background:rgba(34,197,94,0.1);color:#22c55e}.status-in_progress{background:rgba(245,158,11,0.1);color:#f59e0b}
.rel-champion{background:rgba(34,197,94,0.15);color:#16a34a}.rel-target{background:rgba(59,130,246,0.15);color:#2563eb}.rel-cold{background:rgba(156,163,175,0.15);color:#6b7280}.rel-warm{background:rgba(245,158,11,0.15);color:#d97706}
.loading{text-align:center;padding:60px;color:#888}.loading .spinner{width:32px;height:32px;border:3px solid #e5e5e5;border-top-color:var(--maki-purple);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px}@keyframes spin{to{transform:rotate(360deg)}}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center}.modal-overlay.show{display:flex}
.modal{background:white;border-radius:var(--radius);padding:32px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal h3{font-size:18px;font-weight:700;margin-bottom:16px}.modal label{display:block;font-size:12px;font-weight:600;color:#888;margin-bottom:4px;margin-top:12px}
.modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;border:1px solid #e5e5e5;border-radius:6px;font-family:inherit;font-size:13px}.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:8px;margin-top:20px;justify-content:flex-end}.btn-cancel{background:#f5f5f5;color:#666;border:none;padding:8px 16px;border-radius:6px;font-family:inherit;font-size:12px;cursor:pointer}
.empty-state{text-align:center;padding:40px;color:#aaa}.empty-state .icon{font-size:32px;margin-bottom:8px}.empty-state p{font-size:13px}
</style></head><body>
<div class="topbar"><div class="topbar-logo"><svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="6" fill="#5845C2"/><path d="M8 16L14 10L20 16L14 22Z" fill="#45FFC0"/><path d="M16 12L22 18" stroke="#E1FF00" stroke-width="2.5" stroke-linecap="round"/></svg><span>maki</span></div>
<div id="topbarRight" class="topbar-right"><div class="topbar-user"><select id="currentUser" onchange="setCurrentUser(this.value)"><option value="Marc">Marc</option><option value="Paul-Louis">Paul-Louis</option><option value="Olly">Olly</option></select></div><span id="researchBadge" class="topbar-badge" style="display:none">0 new</span></div></div>
<div id="portfolioView" class="portfolio"><h1>Account Intelligence</h1><p class="subtitle">Maki EMEA Expansion ‚Äî Live account plans with auto-updating research</p><div id="accountGrid" class="account-grid"><div class="loading"><div class="spinner"></div>Loading accounts...</div></div></div>
<div id="accountView" class="account-view"><div class="account-hero"><div class="account-hero-inner"><h1 id="accountName"></h1><div class="hero-meta"><span id="accountIndustry"></span><span id="accountHQ"></span><span id="accountEmployees"></span><span id="accountOwner"></span></div></div></div>
<div class="section-nav"><div class="section-nav-inner" id="sectionNav"></div></div><div class="sections-container" id="sectionsContainer"></div></div>
<div id="addAccountModal" class="modal-overlay"><div class="modal"><h3>Add New Account</h3><label>Company Name</label><input type="text" id="newAccountName" placeholder="e.g. Deloitte"><label>Industry</label><input type="text" id="newAccountIndustry" placeholder="e.g. Professional Services"><label>HQ Location</label><input type="text" id="newAccountHQ" placeholder="e.g. London, UK"><label>Website</label><input type="text" id="newAccountWebsite" placeholder="e.g. https://www.deloitte.com"><label>Relationship Stage</label><select id="newAccountStage"><option value="Expansion">Expansion</option><option value="Prospect">Prospect</option><option value="Research">Research</option></select><div class="modal-actions"><button class="btn-cancel" onclick="closeAddAccountModal()">Cancel</button><button class="btn-primary" onclick="createAccount()">Create Account</button></div></div></div><script>
const SUPABASE_URL='https://ytebevamhwgimizmgyfi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZWJldmFtaHdnaW1pem1neWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDYwNTEsImV4cCI6MjA4NzQyMjA1MX0.6rXeJcNUAyTfbmQxoO0VCv9YZ9bq5jExreiezlcngy8';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser='Marc',currentAccountId=null,currentAccount=null,sections={},researchUpdates=[];
function setCurrentUser(n){currentUser=n}
const SECTION_DEFS=[{type:'research_feed',label:'Research Feed',icon:'üì°'},{type:'dashboard_actions',label:'Dashboard',icon:'üéØ'},{type:'org_map',label:'Org Map',icon:'üë•'},{type:'country_tracker',label:'Countries',icon:'üåç'},{type:'revenue_model',label:'Revenue',icon:'üí∞'},{type:'hypotheses',label:'Hypotheses',icon:'üî¨'},{type:'call_prep',label:'Call Prep',icon:'üìû'},{type:'risk_register',label:'Risks',icon:'‚ö†Ô∏è'},{type:'competitive',label:'Competitive',icon:'üèÅ'},{type:'proof_points',label:'Proof Points',icon:'‚úÖ'},{type:'timeline',label:'Timeline',icon:'üìÖ'},{type:'action_plan',label:'Action Plan',icon:'üöÄ'},{type:'raci',label:'RACI',icon:'üìã'}];
async function loadPortfolio(){
const{data:accounts,error}=await sb.from('accounts').select('*').order('name');
if(error){console.error(error);return}
const{data:unread}=await sb.from('research_updates').select('account_id').eq('is_read',false);
const unreadCounts={};(unread||[]).forEach(r=>{unreadCounts[r.account_id]=(unreadCounts[r.account_id]||0)+1});
const{data:sectionCounts}=await sb.from('account_sections').select('account_id');
const secCounts={};(sectionCounts||[]).forEach(s=>{secCounts[s.account_id]=(secCounts[s.account_id]||0)+1});
let html='';accounts.forEach(a=>{
const stageClass=a.relationship_stage==='Expansion'?'stage-expansion':a.relationship_stage==='Won'?'stage-won':'stage-prospect';
const uc=unreadCounts[a.id]||0,sc=secCounts[a.id]||0;
const updated=a.updated_at?new Date(a.updated_at).toLocaleDateString('en-GB',{day:'numeric',month:'short'}):'-';
html+='<div class="account-card" onclick="openAccount(\''+a.id+'\')"><div class="account-card-header"><div><h3>'+a.name+'</h3><div style="font-size:11px;color:#888;margin-top:2px;">'+(a.industry||'')+'</div></div><span class="stage-badge '+stageClass+'">'+a.relationship_stage+'</span></div><div class="meta"><div class="meta-item"><strong>'+(a.hq_location||'-')+'</strong></div><div class="meta-item">Owner: <strong>'+(a.owner||'-')+'</strong></div></div><div style="font-size:12px;color:#666;margin-bottom:12px;line-height:1.4;">'+(a.description||'')+'</div><div class="stats"><div class="stat"><div class="stat-value">'+sc+'</div><div class="stat-label">Sections</div></div><div class="stat"><div class="stat-value">'+uc+'</div><div class="stat-label">New Intel</div></div><div class="stat"><div class="stat-value">'+updated+'</div><div class="stat-label">Updated</div></div></div></div>'});
html+='<div class="add-account-card" onclick="openAddAccountModal()"><div class="add-account-inner"><div class="plus">+</div><p>Add Account</p></div></div>';
document.getElementById('accountGrid').innerHTML=html;
const totalUnread=Object.values(unreadCounts).reduce((a,b)=>a+b,0);const badge=document.getElementById('researchBadge');
if(totalUnread>0){badge.textContent=totalUnread+' new';badge.style.display=''}else{badge.style.display='none'}}
async function openAccount(id){
currentAccountId=id;
const{data:account}=await sb.from('accounts').select('*').eq('id',id).single();currentAccount=account;
const{data:secs}=await sb.from('account_sections').select('*').eq('account_id',id);sections={};(secs||[]).forEach(s=>{sections[s.section_type]=s});
const{data:research}=await sb.from('research_updates').select('*').eq('account_id',id).order('fetched_at',{ascending:false}).limit(50);researchUpdates=research||[];
document.getElementById('accountName').textContent=account.name;
document.getElementById('accountIndustry').textContent=account.industry||'';
document.getElementById('accountHQ').innerHTML='üìç '+(account.hq_location||'');
document.getElementById('accountEmployees').textContent=(account.employee_count||'')+' employees';
document.getElementById('accountOwner').textContent='üë§ '+(account.owner||'');
let navHtml='';SECTION_DEFS.forEach((s,i)=>{navHtml+='<div class="section-tab'+(i===0?' active':'')+'" onclick="switchSection(\''+s.type+'\',this)">'+s.icon+' '+s.label+'</div>'});
document.getElementById('sectionNav').innerHTML=navHtml;
let panelsHtml='';SECTION_DEFS.forEach((s,i)=>{panelsHtml+='<div class="section-panel'+(i===0?' active':'')+'" id="panel-'+s.type+'"></div>'});
document.getElementById('sectionsContainer').innerHTML=panelsHtml;
document.getElementById('topbarRight').innerHTML='<button class="topbar-back" onclick="goBack()">‚Üê Back to Portfolio</button><div class="topbar-user"><select id="currentUser" onchange="setCurrentUser(this.value)"><option value="Marc">Marc</option><option value="Paul-Louis">Paul-Louis</option><option value="Olly">Olly</option></select></div>';
document.getElementById('portfolioView').style.display='none';document.getElementById('accountView').style.display='block';renderSection('research_feed')}
function goBack(){document.getElementById('portfolioView').style.display='';document.getElementById('accountView').style.display='none';
document.getElementById('topbarRight').innerHTML='<div class="topbar-user"><select id="currentUser" onchange="setCurrentUser(this.value)"><option value="Marc">Marc</option><option value="Paul-Louis">Paul-Louis</option><option value="Olly">Olly</option></select></div><span id="researchBadge" class="topbar-badge" style="display:none">0 new</span>';loadPortfolio()}
function switchSection(type,el){document.querySelectorAll('.section-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.section-panel').forEach(p=>p.classList.remove('active'));el.classList.add('active');document.getElementById('panel-'+type).classList.add('active');renderSection(type)}
function renderSection(type){const panel=document.getElementById('panel-'+type);if(!panel)return;
switch(type){case 'research_feed':renderResearchFeed(panel);break;case 'dashboard_actions':renderDashboard(panel);break;case 'org_map':renderOrgMap(panel);break;case 'country_tracker':renderCountryTracker(panel);break;case 'revenue_model':renderRevenueModel(panel);break;case 'hypotheses':renderHypotheses(panel);break;case 'call_prep':renderCallPrep(panel);break;case 'risk_register':renderRiskRegister(panel);break;case 'competitive':renderCompetitive(panel);break;case 'proof_points':renderProofPoints(panel);break;case 'timeline':renderTimeline(panel);break;case 'action_plan':renderActionPlan(panel);break;case 'raci':renderRACI(panel);break}}

    async function refreshResearch(btn) {
      if (!currentAccount) { alert('No account selected'); return; }
      const accountName = document.querySelector('h1')?.textContent || currentAccount;
      btn.disabled = true;
      btn.innerHTML = '\u{23F3} Searching...';
      btn.style.opacity = '0.7';
      try {
        const query = encodeURIComponent(accountName + ' company news');
        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://news.google.com/rss/search?q=' + query + '&hl=en&gl=US&ceid=US:en');
        const resp = await fetch(proxyUrl);
        const text = await resp.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        const items = xml.querySelectorAll('item');
        const existing = sections.research_feed?.data?.updates || [];
        const existingTitles = new Set(existing.map(u => u.title?.toLowerCase().trim()));
        const newUpdates = [];
        const today = new Date().toISOString().split('T')[0];
        items.forEach((item, i) => {
          if (i >= 8) return;
          const title = item.querySelector('title')?.textContent || '';
          if (existingTitles.has(title.toLowerCase().trim())) return;
          const pubDate = item.querySelector('pubDate')?.textContent;
          const date = pubDate ? new Date(pubDate).toISOString().split('T')[0] : today;
          const source = item.querySelector('source')?.textContent || '';
          const catKeywords = {financial:['revenue','profit','earnings','financial','stock','share','investor','fiscal','quarter'],strategy:['strategy','ceo','transformation','restructur','acqui','merger','partnership'],talent:['hiring','workforce','employee','talent','recruit','layoff','headcount'],technology:['ai','cloud','digital','tech','platform','software','data','cyber'],partnerships:['partner','deal','contract','alliance','collaborat','joint'],market:['market','growth','industry','sector','competitor','expand']};
          let bestCat = 'market'; let bestScore = 0;
          Object.entries(catKeywords).forEach(([cat, kws]) => { const score = kws.filter(kw => title.toLowerCase().includes(kw)).length; if (score > bestScore) { bestScore = score; bestCat = cat; } });
          const impact = title.toLowerCase().match(/acqui|merger|revenue|earnings|layoff|major|billion/) ? 'high' : title.toLowerCase().match(/partner|launch|expand|grow/) ? 'medium' : 'low';
          newUpdates.push({id: Date.now() + i, date, title: title.substring(0, 200), summary: source ? 'Source: ' + source : 'Via Google News', category: bestCat, impact, accountRelevance: 'Auto-discovered via news monitoring for ' + accountName});
        });
        if (newUpdates.length > 0) {
          const allUpdates = [...newUpdates, ...existing];
          if (!sections.research_feed) sections.research_feed = {data: {}};
          sections.research_feed.data.updates = allUpdates;
          await saveSection('research_feed');
          btn.innerHTML = '\u{2705} Found ' + newUpdates.length + ' new';
          btn.style.background = '#22c55e';
        } else {
          btn.innerHTML = '\u{2705} Up to date';
          btn.style.background = '#22c55e';
        }
        setTimeout(() => { btn.innerHTML = '\u{1F504} Update Research'; btn.style.background = '#5845C2'; btn.style.opacity = '1'; btn.disabled = false; const p = document.getElementById('content-panel'); if (p) renderResearchFeed(p); }, 2000);
      } catch(e) {
        btn.innerHTML = '\u{274C} Error'; btn.style.background = '#ef4444'; console.error('Research refresh failed:', e);
        setTimeout(() => { btn.innerHTML = '\u{1F504} Update Research'; btn.style.background = '#5845C2'; btn.style.opacity = '1'; btn.disabled = false; }, 2000);
      }
    }

    function renderResearchFeed(panel) {
      const data = sections.research_feed?.data || {};
      const updates = data.updates || [];
      const catColors = {financial:'#2563eb',strategy:'#7c3aed',talent:'#059669',technology:'#d97706',partnerships:'#dc2626',market:'#0891b2','competitive intel':'#e11d48','financial results':'#2563eb','strategic direction':'#7c3aed','hiring & workforce':'#059669','m&a':'#dc2626'};
      const catIcons = {financial:'\u{1F4CA}',strategy:'\u{1F3AF}',talent:'\u{1F465}',technology:'\u{1F4BB}',partnerships:'\u{1F91D}',market:'\u{1F30D}','competitive intel':'\u{1F3C1}','financial results':'\u{1F4CA}','strategic direction':'\u{1F3AF}','hiring & workforce':'\u{1F465}','m&a':'\u{1F91D}'};
      let html = '<div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">';
      html += '<h2 style="margin:0;"><span class="icon">\u{1F4E1}</span> Research Feed</h2>';
      html += '<button id="btn-refresh-research" onclick="refreshResearch(this)" style="display:flex;align-items:center;gap:6px;background:#5845C2;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.85em;font-weight:600;transition:all 0.2s;">\u{1F504} Update Research</button>';
      html += '</div>';
      if (updates.length === 0) {
        html += '<div style="text-align:center;padding:40px;color:#aaa;"><p style="font-size:2em;">\u{1F4E1}</p><p>No research updates yet.</p><p style="font-size:0.85em;">Click \u201CUpdate Research\u201D to fetch latest intelligence.</p></div>';
      } else {
        const highImpact = updates.filter(u => u.impact === 'high').length;
        const cats = [...new Set(updates.map(u => u.category))];
        const latest = updates.reduce((a,b) => (a.date||'') > (b.date||'') ? a : b, updates[0]);
        html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">';
        html += '<div style="background:#f8f7ff;padding:12px;border-radius:8px;text-align:center;"><div style="font-size:1.5em;font-weight:700;color:#5845C2;">' + updates.length + '</div><div style="font-size:0.8em;color:#666;">Total</div></div>';
        html += '<div style="background:#fef2f2;padding:12px;border-radius:8px;text-align:center;"><div style="font-size:1.5em;font-weight:700;color:#ef4444;">' + highImpact + '</div><div style="font-size:0.8em;color:#666;">High Impact</div></div>';
        html += '<div style="background:#f0fdf4;padding:12px;border-radius:8px;text-align:center;"><div style="font-size:1.5em;font-weight:700;color:#059669;">' + cats.length + '</div><div style="font-size:0.8em;color:#666;">Categories</div></div>';
        html += '<div style="background:#fffbeb;padding:12px;border-radius:8px;text-align:center;"><div style="font-size:0.85em;font-weight:700;color:#d97706;">' + (latest.date || 'N/A') + '</div><div style="font-size:0.8em;color:#666;">Latest</div></div>';
        html += '</div>';
        const sorted = [...updates].sort((a,b) => (b.date||'').localeCompare(a.date||''));
        sorted.forEach(u => {
          const cat = (u.category || 'market').toLowerCase();
          const color = catColors[cat] || '#666';
          const icon = catIcons[cat] || '\u{1F4CC}';
          const impC = u.impact === 'high' ? '#ef4444' : u.impact === 'medium' ? '#f59e0b' : '#22c55e';
          html += '<div style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:12px;">';
          html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">';
          html += '<span style="background:' + color + '22;color:' + color + ';padding:2px 10px;border-radius:12px;font-size:0.8em;font-weight:600;">' + icon + ' ' + cat.charAt(0).toUpperCase() + cat.slice(1) + '</span>';
          html += '<span style="background:' + impC + '22;color:' + impC + ';padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:600;">' + (u.impact||'medium').toUpperCase() + '</span>';
          html += '<span style="margin-left:auto;color:#999;font-size:0.8em;">' + (u.date||'') + '</span></div>';
          html += '<div style="font-weight:600;margin-bottom:6px;">' + (u.title||'') + '</div>';
          html += '<div style="color:#555;font-size:0.9em;line-height:1.5;">' + (u.summary||'') + '</div>';
          if (u.accountRelevance) {
            html += '<div style="margin-top:10px;border-left:3px solid #5845C2;padding:8px 12px;background:#f8f7ff;border-radius:4px;">';
            html += '<div style="font-size:0.75em;text-transform:uppercase;color:#5845C2;font-weight:600;margin-bottom:2px;">Account Relevance</div>';
            html += '<div style="color:#444;font-size:0.85em;">' + u.accountRelevance + '</div></div>';
          }
          html += '</div>';
        });
      }
      html += '</div>';
      panel.innerHTML = html;
    }
async function markRead(id,el){await sb.from('research_updates').update({is_read:true}).eq('id',id);el.classList.remove('unread')}
function renderDashboard(panel) {
      const contacts = sections.org_map?.data?.contacts || [];
      const countries = sections.country_tracker?.data?.countries || [];
      const hypotheses = sections.hypotheses?.data?.hypotheses || [];
      const risks = sections.risk_register?.data?.risks || [];
      const competitors = sections.competitive?.data?.competitors || [];
      const callPreps = sections.call_prep?.data?.preps || [];
      const actionPlan = sections.action_plan?.data?.phases || [];
      const researchData = sections.research_feed?.data?.updates || [];
      const thesis = sections.account_thesis?.data || null;
      const dims = [
        {name:'Contacts',weight:15,score:Math.min(contacts.length/5,1)*100},
        {name:'Countries',weight:15,score:Math.min(countries.length/3,1)*100},
        {name:'Hypotheses',weight:15,score:Math.min(hypotheses.length/3,1)*100},
        {name:'Risks',weight:10,score:Math.min(risks.length/3,1)*100},
        {name:'Competitors',weight:10,score:Math.min(competitors.length/2,1)*100},
        {name:'Call Preps',weight:10,score:Math.min(callPreps.length/2,1)*100},
        {name:'Action Plan',weight:15,score:Math.min(actionPlan.length/2,1)*100},
        {name:'Research',weight:10,score:Math.min(researchData.length/3,1)*100}
      ];
      const healthScore = Math.round(dims.reduce((s,d) => s + (d.score * d.weight / 100), 0));
      const scoreColor = healthScore >= 80 ? '#22c55e' : healthScore >= 50 ? '#f59e0b' : '#ef4444';
      const circumference = 2 * Math.PI * 54;
      const offset = circumference - (healthScore / 100) * circumference;
      let html = '<div class="card">';
      if (thesis) {
        html += '<div style="background:linear-gradient(135deg,#f8f7ff,#eef0ff);border:1px solid #d4d0f0;border-radius:12px;padding:20px;margin-bottom:24px;">';
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;"><span style="font-size:1.3em;">\u{1F3AF}</span><strong style="font-size:1.1em;color:#5845C2;">Account Thesis</strong></div>';
        if (thesis.objective) html += '<div style="font-size:1em;font-weight:600;color:#1a1a2e;margin-bottom:8px;">' + thesis.objective + '</div>';
        if (thesis.narrative) html += '<div style="color:#444;line-height:1.6;margin-bottom:12px;">' + thesis.narrative + '</div>';
        if (thesis.winThemes && thesis.winThemes.length) {
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">';
          thesis.winThemes.forEach(w => { html += '<span style="background:#5845C2;color:white;padding:4px 12px;border-radius:16px;font-size:0.8em;font-weight:600;">' + w + '</span>'; });
          html += '</div>';
        }
        if (thesis.targetOutcome) html += '<div style="font-size:0.85em;color:#666;border-top:1px solid #d4d0f0;padding-top:8px;margin-top:8px;">\u{1F3C6} Target: ' + thesis.targetOutcome + '</div>';
        html += '</div>';
      }
      html += '<h2><span class="icon">\u{1F4CA}</span> Account Dashboard</h2>';
      html += '<div style="display:grid;grid-template-columns:200px 1fr;gap:24px;margin-bottom:24px;">';
      html += '<div style="text-align:center;"><svg width="140" height="140" viewBox="0 0 120 120"><circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="8"/>';
      html += '<circle cx="60" cy="60" r="54" fill="none" stroke="' + scoreColor + '" stroke-width="8" stroke-linecap="round" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '" transform="rotate(-90 60 60)"/>';
      html += '<text x="60" y="55" text-anchor="middle" font-size="28" font-weight="700" fill="' + scoreColor + '">' + healthScore + '</text>';
      html += '<text x="60" y="72" text-anchor="middle" font-size="10" fill="#666">Health Score</text></svg>';
      html += '<div style="margin-top:8px;font-size:0.85em;color:#666;">Plan Completeness</div></div>';
      html += '<div>';
      dims.forEach(d => {
        const bc = d.score >= 80 ? '#22c55e' : d.score >= 50 ? '#f59e0b' : '#ef4444';
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">';
        html += '<div style="width:90px;font-size:0.8em;color:#555;text-align:right;">' + d.name + '</div>';
        html += '<div style="flex:1;background:#f3f4f6;border-radius:4px;height:14px;overflow:hidden;"><div style="width:' + d.score + '%;height:100%;background:' + bc + ';border-radius:4px;"></div></div>';
        html += '<div style="width:35px;font-size:0.75em;color:#666;">' + Math.round(d.score) + '%</div></div>';
      });
      html += '</div></div>';
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">';
      html += '<div style="background:#f8f7ff;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:1.8em;font-weight:700;color:#5845C2;">' + contacts.length + '</div><div style="font-size:0.8em;color:#666;">Contacts</div></div>';
      html += '<div style="background:#f0fdf4;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:1.8em;font-weight:700;color:#059669;">' + countries.length + '</div><div style="font-size:0.8em;color:#666;">Countries</div></div>';
      const openActions = actionPlan.reduce((c,p) => c + (p.actions||[]).filter(a => typeof a === 'string' ? true : a.status !== 'Complete').length, 0);
      html += '<div style="background:#fffbeb;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:1.8em;font-weight:700;color:#d97706;">' + openActions + '</div><div style="font-size:0.8em;color:#666;">Open Actions</div></div>';
      html += '<div style="background:#fef2f2;padding:16px;border-radius:8px;text-align:center;"><div style="font-size:1.8em;font-weight:700;color:#ef4444;">' + researchData.length + '</div><div style="font-size:0.8em;color:#666;">Research</div></div></div>';
      const allActions = [];
      actionPlan.forEach(p => { (p.actions||[]).forEach(a => {
        if (typeof a === 'string') allActions.push({action:a,owner:'',priority:'',due:'',phase:p.name,status:p.status});
        else if (a.status !== 'Complete') allActions.push({...a,phase:p.name});
      }); });
      const activeActions = allActions.filter(a => a.status === 'active');
      const topActions = (activeActions.length > 0 ? activeActions : allActions).slice(0,5);
      if (topActions.length > 0) {
        html += '<div style="margin-bottom:24px;"><h3 style="font-size:1em;margin-bottom:10px;">\u{26A1} Next Actions <span style="font-size:0.8em;color:#666;font-weight:400;">(' + (activeActions.length > 0 ? topActions[0].phase : 'All') + ')</span></h3>';
        topActions.forEach(a => {
          html += '<div style="display:flex;align-items:start;gap:10px;padding:10px 0;border-bottom:1px solid #f3f4f6;">';
          html += '<span style="color:#5845C2;font-size:1.1em;margin-top:1px;">\u25B8</span>';
          html += '<div style="flex:1;"><div style="font-weight:500;font-size:0.9em;">' + (a.action||'') + '</div>';
          if (a.owner) html += '<div style="font-size:0.8em;color:#666;margin-top:2px;">Owner: ' + a.owner + (a.due ? ' \u00B7 Due: ' + a.due : '') + '</div>';
          html += '</div>';
          if (a.priority) { const pc = a.priority==='Critical'?'#ef4444':a.priority==='High'?'#f59e0b':'#22c55e'; html += '<span style="background:'+pc+'22;color:'+pc+';padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:600;">'+a.priority+'</span>'; }
          html += '</div>';
        });
        html += '</div>';
      }
      if (researchData.length > 0) {
        const topR = [...researchData].sort((a,b) => (b.date||'').localeCompare(a.date||'')).slice(0,3);
        html += '<div style="margin-bottom:24px;"><h3 style="font-size:1em;margin-bottom:10px;">\u{1F4E1} Latest Intelligence</h3>';
        topR.forEach(u => {
          const ic = u.impact==='high'?'#ef4444':u.impact==='medium'?'#f59e0b':'#22c55e';
          html += '<div style="display:flex;align-items:start;gap:10px;padding:8px 0;border-bottom:1px solid #f3f4f6;">';
          html += '<span style="background:'+ic+'22;color:'+ic+';padding:2px 6px;border-radius:6px;font-size:0.7em;font-weight:600;white-space:nowrap;margin-top:2px;">'+(u.impact||'').toUpperCase()+'</span>';
          html += '<div><div style="font-weight:600;font-size:0.9em;">'+(u.title||'')+'</div>';
          html += '<div style="color:#666;font-size:0.8em;margin-top:2px;">'+(u.summary||'').substring(0,120)+'...</div></div></div>';
        });
        html += '</div>';
      }
      if (contacts.length > 0) {
        const rc = {}; contacts.forEach(c => { const r=c.relationship||'Unknown'; rc[r]=(rc[r]||0)+1; });
        const relCol = {'Champion':'#22c55e','Warm but Unresponsive':'#f59e0b','No Contact':'#ef4444','Supportive':'#3b82f6','Neutral':'#6b7280'};
        html += '<div><h3 style="font-size:1em;margin-bottom:10px;">\u{1F465} Relationship Map</h3><div style="display:flex;gap:12px;flex-wrap:wrap;">';
        Object.entries(rc).forEach(([r,c]) => {
          const col = relCol[r]||'#6b7280';
          html += '<div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:'+col+'15;border:1px solid '+col+'33;border-radius:8px;">';
          html += '<div style="width:10px;height:10px;border-radius:50%;background:'+col+';"></div>';
          html += '<span style="font-size:0.85em;font-weight:500;">'+r+'</span><span style="font-size:0.85em;font-weight:700;color:'+col+';">'+c+'</span></div>';
        });
        html += '</div></div>';
      }
      html += '</div>';
      panel.innerHTML = html;
    }
function renderOrgMap(panel) {
      const data = sections.org_map?.data || {contacts: []};
      const contacts = data.contacts || [];
      const relColors = {'Champion':'#22c55e','Warm but Unresponsive':'#f59e0b','Supportive':'#3b82f6','Neutral':'#6b7280','No Contact':'#ef4444','Blocker':'#dc2626'};
      let html = '<div class="card"><h2><span class="icon">\u{1F465}</span> Key Contacts</h2>';
      html += '<table style="width:100%;border-collapse:collapse;"><tr style="border-bottom:2px solid #e5e7eb;">';
      html += '<th style="padding:10px;text-align:left;font-size:0.8em;text-transform:uppercase;color:#666;">Name</th>';
      html += '<th style="padding:10px;text-align:left;font-size:0.8em;text-transform:uppercase;color:#666;">Title</th>';
      html += '<th style="padding:10px;text-align:left;font-size:0.8em;text-transform:uppercase;color:#666;">Country</th>';
      html += '<th style="padding:10px;text-align:left;font-size:0.8em;text-transform:uppercase;color:#666;">Relationship</th>';
      html += '<th style="padding:10px;text-align:left;font-size:0.8em;text-transform:uppercase;color:#666;">Notes</th>';
      html += '<th style="width:30px;"></th></tr>';
      contacts.forEach((c, i) => {
        const rel = c.relationship || 'Unknown';
        const rc = relColors[rel] || '#6b7280';
        html += '<tr style="border-bottom:1px solid #f3f4f6;">';
        html += '<td style="padding:10px;font-weight:600;">' + (c.name||'') + '</td>';
        html += '<td style="padding:10px;font-size:0.9em;color:#555;">' + (c.title||'') + '</td>';
        html += '<td style="padding:10px;font-size:0.9em;">' + (c.country||'') + '</td>';
        html += '<td style="padding:10px;"><span style="background:'+rc+'18;color:'+rc+';padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:600;border:1px solid '+rc+'33;white-space:nowrap;">'+rel+'</span></td>';
        html += '<td style="padding:10px;font-size:0.85em;color:#666;max-width:300px;">' + (c.notes||'').substring(0,120) + (c.notes?.length>120?'...':'') + '</td>';
        html += '<td style="padding:10px;color:#ccc;cursor:pointer;">\u00D7</td>';
        html += '</tr>';
      });
      html += '</table>';
      html += '<div style="padding:10px;"><button onclick="const c={id:Date.now().toString(),name:\u0027New Contact\u0027,title:\u0027\u0027,country:\u0027\u0027,relationship:\u0027No Contact\u0027,notes:\u0027\u0027};sections.org_map.data.contacts.push(c);saveSection(\u0027org_map\u0027);renderOrgMap(this.closest(\u0027.card\u0027).parentElement);" style="background:none;border:1px dashed #ccc;padding:8px 16px;border-radius:6px;cursor:pointer;color:#888;font-size:0.85em;">+ Add contact</button></div>';
      html += '</div>';
      panel.innerHTML = html;
    }
function renderCountryTracker(panel){
const data=sections.country_tracker?.data||{countries:[]};const countries=data.countries||[];
let html='<div class="card"><h2><span class="icon">üåç</span> EMEA Country Tracker</h2><table><tr><th>Country</th><th>Status</th><th>Contact</th><th>Notes</th><th style="width:30px;"></th></tr>';
countries.forEach((c,i)=>{html+='<tr><td style="font-weight:600;">'+(c.flag||'üè≥Ô∏è')+' <span contenteditable="true" class="editable" onblur="updateSectionField(\'country_tracker\',\'countries\','+i+',\'name\',this.textContent.trim())">'+c.name+'</span></td><td><select class="edit-select" onchange="updateSectionField(\'country_tracker\',\'countries\','+i+',\'status\',this.value)">';
['Active Client','Target','Research','Paused'].forEach(s=>{html+='<option value="'+s+'"'+(c.status===s?' selected':'')+'>'+s+'</option>'});
html+='</select></td><td><div contenteditable="true" class="editable" style="font-size:12px;" onblur="updateSectionField(\'country_tracker\',\'countries\','+i+',\'contact\',this.textContent.trim())">'+(c.contact||'')+'</div></td><td><div contenteditable="true" class="editable" style="font-size:11px;color:#666;" onblur="updateSectionField(\'country_tracker\',\'countries\','+i+',\'notes\',this.textContent.trim())">'+(c.notes||'')+'</div></td><td><button class="btn-delete" onclick="deleteFromArray(\'country_tracker\',\'countries\','+i+')">√ó</button></td></tr>'});
html+='</table><div style="padding:8px 16px;"><button class="btn-add" onclick="addToArray(\'country_tracker\',\'countries\',{name:\'New Country\',flag:\'üè≥Ô∏è\',status:\'Research\',contact:\'TBC\',notes:\'\'})">+ Add country</button></div></div>';panel.innerHTML=html}
function renderRevenueModel(panel){
const data=sections.revenue_model?.data||{pricingBasis:120,scenarios:[]};const scenarios=data.scenarios||[];
let html='<div class="card"><h2><span class="icon">üí∞</span> Revenue Model</h2><div style="margin-bottom:16px;font-size:13px;">Pricing basis: <strong contenteditable="true" class="editable" onblur="updateSectionDirectField(\'revenue_model\',\'pricingBasis\',parseInt(this.textContent.replace(/[^0-9]/g,\'\'))||120)">‚Ç¨'+(data.pricingBasis||120)+'</strong> per assessment</div><table><tr><th>Scenario</th><th>Countries</th><th>Assessments/Country</th><th>Price</th><th>Annual Revenue</th></tr>';
scenarios.forEach((s,i)=>{const rev=s.countries*s.assessmentsPerCountry*s.pricePerAssessment;
html+='<tr><td style="font-weight:600;">'+s.name+'</td><td style="text-align:center;"><div contenteditable="true" class="editable" onblur="updateSectionField(\'revenue_model\',\'scenarios\','+i+',\'countries\',parseInt(this.textContent)||0)">'+s.countries+'</div></td><td style="text-align:center;"><div contenteditable="true" class="editable" onblur="updateSectionField(\'revenue_model\',\'scenarios\','+i+',\'assessmentsPerCountry\',parseInt(this.textContent)||0)">'+s.assessmentsPerCountry+'</div></td><td style="text-align:center;">‚Ç¨'+s.pricePerAssessment+'</td><td style="text-align:center;font-weight:700;color:var(--maki-purple);">‚Ç¨'+rev.toLocaleString()+'</td></tr>'});
html+='</table></div>';panel.innerHTML=html}
function renderHypotheses(panel){const data=sections.hypotheses?.data||{hypotheses:[]};const hyps=data.hypotheses||[];let html='<div class="card"><h2><span class="icon">üî¨</span> Strategic Hypotheses</h2>';hyps.forEach((h,i)=>{html+='<div style="padding:12px;border-radius:8px;background:var(--maki-grey-light);margin-bottom:8px;"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;"><div contenteditable="true" class="editable" style="font-weight:600;font-size:13px;flex:1;" onblur="updateSectionField(\'hypotheses\',\'hypotheses\','+i+',\'hypothesis\',this.textContent.trim())">'+h.hypothesis+'</div><select class="edit-select" style="margin-left:8px;" onchange="updateSectionField(\'hypotheses\',\'hypotheses\','+i+',\'status\',this.value);renderSection(\'hypotheses\')">';['Unvalidated','Testing','Validated','Disproven'].forEach(s=>{html+='<option value="'+s+'"'+(h.status===s?' selected':'')+'>'+s+'</option>'});html+='</select></div><div contenteditable="true" class="editable" style="font-size:12px;color:#666;" onblur="updateSectionField(\'hypotheses\',\'hypotheses\','+i+',\'evidence\',this.textContent.trim())">'+(h.evidence||'')+'</div></div>'});html+='<button class="btn-add" onclick="addToArray(\'hypotheses\',\'hypotheses\',{id:Date.now(),hypothesis:\'New hypothesis\',status:\'Unvalidated\',evidence:\'\'})">+ Add hypothesis</button></div>';panel.innerHTML=html}
function renderCallPrep(panel) {
      const data = sections.call_prep?.data || {preps: []};
      const preps = data.preps || [];
      let html = '<div class="card"><h2><span class="icon">\u{1F4DE}</span> Call Preparation</h2>';
      if (preps.length === 0) {
        html += '<div style="text-align:center;padding:40px;color:#aaa;"><p style="font-size:2em;">\u{1F4DE}</p><p>No call prep items yet.</p></div>';
      } else {
        preps.forEach(p => {
          const topic = p.topic || p.stakeholder || 'General';
          const isObj = topic.toLowerCase().includes('objection');
          const bdrC = isObj ? '#ef4444' : '#5845C2';
          const bgC = isObj ? '#fef2f2' : '#f8f7ff';
          const ico = isObj ? '\u{1F6E1}' : '\u{1F3AF}';
          html += '<div style="border-left:4px solid '+bdrC+';background:'+bgC+';padding:16px;margin:12px 0;border-radius:8px;">';
          html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">';
          html += '<span style="font-size:1.3em;">'+ico+'</span><strong style="font-size:1.05em;">'+topic+'</strong>';
          if (isObj) html += '<span style="background:#ef4444;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:600;">OBJECTION</span>';
          html += '</div>';
          if (p.context) { html += '<div style="margin-bottom:10px;"><div style="font-size:0.75em;text-transform:uppercase;color:#888;font-weight:600;margin-bottom:3px;">Context</div><div style="color:#444;font-size:0.9em;line-height:1.5;">'+p.context+'</div></div>'; }
          if (p.whyNow) { html += '<div style="margin-bottom:10px;background:#fffbeb;padding:8px 12px;border-radius:6px;"><div style="font-size:0.75em;text-transform:uppercase;color:#d97706;font-weight:600;margin-bottom:3px;">\u{23F0} Why Now</div><div style="color:#444;font-size:0.9em;">'+p.whyNow+'</div></div>'; }
          if (p.leadWith) { html += '<div style="margin-bottom:10px;background:#f0fdf4;padding:8px 12px;border-radius:6px;"><div style="font-size:0.75em;text-transform:uppercase;color:#059669;font-weight:600;margin-bottom:3px;">\u{2705} Lead With</div><div style="color:#444;font-size:0.9em;">'+p.leadWith+'</div></div>'; }
          if (p.dontMention) { html += '<div style="margin-bottom:10px;background:#fef2f2;padding:8px 12px;border-radius:6px;"><div style="font-size:0.75em;text-transform:uppercase;color:#ef4444;font-weight:600;margin-bottom:3px;">\u{1F6AB} Don\u2019t Mention</div><div style="color:#444;font-size:0.9em;">'+p.dontMention+'</div></div>'; }
          const questions = p.questions || p.keyQuestions || '';
          if (questions) {
            const qs = questions.split('?').filter(q => q.trim());
            if (qs.length > 0) { html += '<div style="margin-bottom:10px;"><div style="font-size:0.75em;text-transform:uppercase;color:#666;font-weight:600;margin-bottom:4px;">Key Questions</div>';
              qs.forEach(q => { html += '<div style="font-style:italic;color:#444;padding:2px 0;font-size:0.9em;">\u201C'+q.trim()+'?\u201D</div>'; });
              html += '</div>'; }
          }
          const notes = p.notes || p.talkingPoints || '';
          if (notes) {
            html += '<div style="border-left:3px solid '+bdrC+';padding:8px 12px;background:white;border-radius:4px;margin-top:8px;">';
            html += '<div style="font-size:0.75em;text-transform:uppercase;color:'+bdrC+';margin-bottom:4px;font-weight:600;">'+(isObj?'Response Strategy':'Talking Points')+'</div>';
            html += '<div style="color:#333;line-height:1.5;font-size:0.9em;">'+notes+'</div></div>';
          }
          if (p.objections && p.objections.length) {
            html += '<div style="margin-top:10px;"><div style="font-size:0.75em;text-transform:uppercase;color:#ef4444;font-weight:600;margin-bottom:4px;">Objection Responses</div>';
            p.objections.forEach(ob => { html += '<div style="background:white;padding:8px 12px;border-radius:6px;margin-bottom:6px;border:1px solid #fecaca;"><div style="font-weight:600;font-size:0.85em;color:#ef4444;">\u201C'+(ob.obj||ob.objection||'')+'\u201D</div><div style="color:#444;font-size:0.85em;margin-top:4px;">'+(ob.response||'')+'</div></div>'; });
            html += '</div>';
          }
          if (p.nextStepAsk) { html += '<div style="margin-top:10px;background:#5845C222;padding:8px 12px;border-radius:6px;"><div style="font-size:0.75em;text-transform:uppercase;color:#5845C2;font-weight:600;margin-bottom:3px;">\u{1F3AF} Next Step Ask</div><div style="color:#333;font-size:0.9em;font-weight:500;">'+p.nextStepAsk+'</div></div>'; }
          html += '</div>';
        });
      }
      html += '</div>';
      panel.innerHTML = html;
    }
function renderRiskRegister(panel){const data=sections.risk_register?.data||{risks:[]};const risks=data.risks||[];let html='<div class="card"><h2><span class="icon">‚ö†Ô∏è</span> Risk Register</h2><table><tr><th>Risk</th><th style="width:80px;">Impact</th><th style="width:80px;">Likelihood</th><th>Mitigation</th><th style="width:30px;"></th></tr>';risks.forEach((r,i)=>{html+='<tr><td><div contenteditable="true" class="editable" onblur="updateSectionField(\'risk_register\',\'risks\','+i+',\'risk\',this.textContent.trim())">'+r.risk+'</div></td><td><select class="edit-select" onchange="updateSectionField(\'risk_register\',\'risks\','+i+',\'impact\',this.value)">';['high','medium','low'].forEach(v=>{html+='<option value="'+v+'"'+(r.impact===v?' selected':'')+'>'+v.charAt(0).toUpperCase()+v.slice(1)+'</option>'});html+='</select></td><td><select class="edit-select" onchange="updateSectionField(\'risk_register\',\'risks\','+i+',\'likelihood\',this.value)">';['high','medium','low'].forEach(v=>{html+='<option value="'+v+'"'+(r.likelihood===v?' selected':'')+'>'+v.charAt(0).toUpperCase()+v.slice(1)+'</option>'});html+='</select></td><td><div contenteditable="true" class="editable" style="font-size:12px;color:#666;" onblur="updateSectionField(\'risk_register\',\'risks\','+i+',\'mitigation\',this.textContent.trim())">'+(r.mitigation||'')+'</div></td><td><button class="btn-delete" onclick="deleteFromArray(\'risk_register\',\'risks\','+i+')">√ó</button></td></tr>'});html+='</table><div style="padding:8px 16px;"><button class="btn-add" onclick="addToArray(\'risk_register\',\'risks\',{id:Date.now(),risk:\'New risk\',impact:\'medium\',likelihood:\'medium\',mitigation:\'\'})">+ Add risk</button></div></div>';panel.innerHTML=html}
function renderCompetitive(panel){const data=sections.competitive?.data||{competitors:[]};const comps=data.competitors||[];let html='<div class="card"><h2><span class="icon">üèÅ</span> Competitive Landscape</h2><table><tr><th>Competitor</th><th>Strengths</th><th>Weaknesses</th><th style="width:80px;">Threat</th><th style="width:30px;"></th></tr>';comps.forEach((c,i)=>{html+='<tr><td style="font-weight:600;"><div contenteditable="true" class="editable" onblur="updateSectionField(\'competitive\',\'competitors\','+i+',\'name\',this.textContent.trim())">'+c.name+'</div></td><td><div contenteditable="true" class="editable" style="font-size:12px;" onblur="updateSectionField(\'competitive\',\'competitors\','+i+',\'strengths\',this.textContent.trim())">'+(c.strengths||'')+'</div></td><td><div contenteditable="true" class="editable" style="font-size:12px;" onblur="updateSectionField(\'competitive\',\'competitors\','+i+',\'weaknesses\',this.textContent.trim())">'+(c.weaknesses||'')+'</div></td><td><select class="edit-select" onchange="updateSectionField(\'competitive\',\'competitors\','+i+',\'threat\',this.value)">';['high','medium','low'].forEach(v=>{html+='<option value="'+v+'"'+(c.threat===v?' selected':'')+'>'+v.charAt(0).toUpperCase()+v.slice(1)+'</option>'});html+='</select></td><td><button class="btn-delete" onclick="deleteFromArray(\'competitive\',\'competitors\','+i+')">√ó</button></td></tr>'});html+='</table><div style="padding:8px 16px;"><button class="btn-add" onclick="addToArray(\'competitive\',\'competitors\',{name:\'New Competitor\',strengths:\'\',weaknesses:\'\',threat:\'medium\'})">+ Add competitor</button></div></div>';panel.innerHTML=html}
function renderProofPoints(panel){const data=sections.proof_points?.data||{proofPoints:[]};const points=data.proofPoints||[];let html='<div class="card"><h2><span class="icon">‚úÖ</span> Proof Points</h2>';points.forEach((p,i)=>{html+='<div style="padding:12px;border-radius:8px;background:var(--maki-grey-light);margin-bottom:8px;display:flex;justify-content:space-between;"><div style="flex:1;"><div contenteditable="true" class="editable" style="font-weight:600;font-size:13px;" onblur="updateSectionField(\'proof_points\',\'proofPoints\','+i+',\'title\',this.textContent.trim())">'+p.title+'</div><span class="status-badge status-active" style="margin:4px 0;display:inline-block;">'+(p.type||'Evidence')+'</span><div contenteditable="true" class="editable" style="font-size:12px;color:#666;margin-top:4px;" onblur="updateSectionField(\'proof_points\',\'proofPoints\','+i+',\'detail\',this.textContent.trim())">'+(p.detail||'')+'</div></div><button class="btn-delete" onclick="deleteFromArray(\'proof_points\',\'proofPoints\','+i+')">√ó</button></div>'});html+='<button class="btn-add" onclick="addToArray(\'proof_points\',\'proofPoints\',{id:Date.now(),title:\'New proof point\',type:\'Evidence\',detail:\'\'})">+ Add proof point</button></div>';panel.innerHTML=html}
function renderTimeline(panel){const data=sections.timeline?.data||{milestones:[]};const ms=data.milestones||[];let html='<div class="card"><h2><span class="icon">üìÖ</span> Timeline</h2><div style="position:relative;padding-left:24px;">';ms.forEach((m,i)=>{html+='<div style="position:relative;padding:12px 0 12px 20px;border-left:2px solid #e5e5e5;"><div style="position:absolute;left:-7px;top:16px;width:12px;height:12px;border-radius:50%;background:'+(m.status==='completed'?'#22c55e':m.status==='in_progress'?'#f59e0b':'#ddd')+';border:2px solid white;"></div><div style="display:flex;gap:12px;align-items:center;"><div contenteditable="true" class="editable" style="font-weight:600;font-size:12px;color:var(--maki-purple);min-width:80px;" onblur="updateSectionField(\'timeline\',\'milestones\','+i+',\'date\',this.textContent.trim())">'+m.date+'</div><div contenteditable="true" class="editable" style="font-size:13px;flex:1;" onblur="updateSectionField(\'timeline\',\'milestones\','+i+',\'event\',this.textContent.trim())">'+m.event+'</div><select class="edit-select" onchange="updateSectionField(\'timeline\',\'milestones\','+i+',\'status\',this.value);renderSection(\'timeline\')">';['completed','in_progress','planned'].forEach(s=>{html+='<option value="'+s+'"'+(m.status===s?' selected':'')+'>'+s.replace('_',' ')+'</option>'});html+='</select><button class="btn-delete" onclick="deleteFromArray(\'timeline\',\'milestones\','+i+')">√ó</button></div></div>'});html+='</div><button class="btn-add" style="margin-top:8px;" onclick="addToArray(\'timeline\',\'milestones\',{id:Date.now(),date:\'TBC\',event:\'New milestone\',status:\'planned\'})">+ Add milestone</button></div>';panel.innerHTML=html}
function renderActionPlan(panel) {
      const data = sections.action_plan?.data || {phases: []};
      const phases = data.phases || [];
      let html = '<div class="card"><h2><span class="icon">\u{1F680}</span> Action Plan</h2>';
      phases.forEach((p, pi) => {
        const isActive = p.status === 'active';
        const borderColor = isActive ? '#5845C2' : '#e5e7eb';
        const bgColor = isActive ? '#f8f7ff' : 'white';
        html += '<div style="border:1px solid '+borderColor+';border-radius:8px;padding:16px;margin-bottom:16px;background:'+bgColor+';">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
        html += '<strong style="font-size:1em;">'+(p.name||'Phase')+'</strong>';
        const sc = {active:'#5845C2',planned:'#6b7280',completed:'#22c55e'}[p.status] || '#6b7280';
        html += '<span style="background:'+sc+'18;color:'+sc+';padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:600;">'+(p.status||'planned')+'</span></div>';
        (p.actions||[]).forEach((a, ai) => {
          const isStr = typeof a === 'string';
          const text = isStr ? a : (a.action||'');
          const owner = isStr ? '' : (a.owner||'');
          const due = isStr ? '' : (a.due||'');
          const priority = isStr ? '' : (a.priority||'');
          const status = isStr ? '' : (a.status||'');
          const isDone = status === 'Complete';
          html += '<div style="display:flex;align-items:start;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6;'+(isDone?'opacity:0.5;':'')+'">';
          html += '<span style="color:'+(isDone?'#22c55e':'#ccc')+';margin-top:2px;">'+(isDone?'\u2713':'\u25CB')+'</span>';
          html += '<div style="flex:1;"><div style="font-size:0.9em;'+(isDone?'text-decoration:line-through;':'')+'">'+text+'</div>';
          if (owner||due) { html += '<div style="font-size:0.8em;color:#888;margin-top:2px;">'; if(owner) html += '\u{1F464} '+owner; if(owner&&due) html += ' \u00B7 '; if(due) html += '\u{1F4C5} '+due; html += '</div>'; }
          html += '</div>';
          if (priority) { const pc = priority==='Critical'?'#ef4444':priority==='High'?'#f59e0b':'#22c55e'; html += '<span style="background:'+pc+'22;color:'+pc+';padding:2px 6px;border-radius:8px;font-size:0.7em;font-weight:600;">'+priority+'</span>'; }
          html += '</div>';
        });
        html += '</div>';
      });
      html += '</div>';
      panel.innerHTML = html;
    }
function renderRACI(panel){const data=sections.raci?.data||{matrix:[]};const matrix=data.matrix||[];let html='<div class="card"><h2><span class="icon">üìã</span> RACI Matrix</h2><table><tr><th>Task</th><th style="width:100px;">Responsible</th><th style="width:100px;">Accountable</th><th style="width:100px;">Consulted</th><th style="width:100px;">Informed</th></tr>';matrix.forEach((m,i)=>{html+='<tr><td><div contenteditable="true" class="editable" style="font-weight:600;" onblur="updateSectionField(\'raci\',\'matrix\','+i+',\'task\',this.textContent.trim())">'+m.task+'</div></td>';['responsible','accountable','consulted','informed'].forEach(role=>{html+='<td style="text-align:center;"><div contenteditable="true" class="editable" style="font-size:12px;" onblur="updateSectionField(\'raci\',\'matrix\','+i+',\''+role+'\',this.textContent.trim())">'+(m[role]||'')+'</div></td>'});html+='</tr>'});html+='</table><div style="padding:8px 16px;"><button class="btn-add" onclick="addToArray(\'raci\',\'matrix\',{task:\'New task\',responsible:\'\',accountable:\'\',consulted:\'\',informed:\'\'})">+ Add row</button></div></div>';panel.innerHTML=html}
async function updateSectionField(sectionType,arrayName,index,field,value){const sec=sections[sectionType];if(!sec)return;sec.data[arrayName][index][field]=value;await sb.from('account_sections').update({data:sec.data,updated_by:currentUser}).eq('id',sec.id);logActivity('Updated '+sectionType+' ‚Üí '+field)}
async function updateSectionDirectField(sectionType,field,value){const sec=sections[sectionType];if(!sec)return;sec.data[field]=value;await sb.from('account_sections').update({data:sec.data,updated_by:currentUser}).eq('id',sec.id)}
async function addToArray(sectionType,arrayName,newItem){let sec=sections[sectionType];if(!sec){const{data}=await sb.from('account_sections').insert({account_id:currentAccountId,section_type:sectionType,data:{[arrayName]:[newItem]},updated_by:currentUser}).select().single();sections[sectionType]=data}else{if(!sec.data[arrayName])sec.data[arrayName]=[];sec.data[arrayName].push(newItem);await sb.from('account_sections').update({data:sec.data,updated_by:currentUser}).eq('id',sec.id)}renderSection(sectionType);logActivity('Added item to '+sectionType)}
async function deleteFromArray(sectionType,arrayName,index){const sec=sections[sectionType];if(!sec)return;sec.data[arrayName].splice(index,1);await sb.from('account_sections').update({data:sec.data,updated_by:currentUser}).eq('id',sec.id);renderSection(sectionType);logActivity('Deleted item from '+sectionType)}
async function logActivity(action){await sb.from('activity_log').insert({account_id:currentAccountId,user_name:currentUser,action:action})}
function openAddAccountModal(){document.getElementById('addAccountModal').classList.add('show')}
function closeAddAccountModal(){document.getElementById('addAccountModal').classList.remove('show')}
async function createAccount(){const name=document.getElementById('newAccountName').value.trim();if(!name)return;const slug=name.toLowerCase().replace(/[^a-z0-9]+/g,'-');
const{data,error}=await sb.from('accounts').insert({name:name,slug:slug,industry:document.getElementById('newAccountIndustry').value.trim(),hq_location:document.getElementById('newAccountHQ').value.trim(),website:document.getElementById('newAccountWebsite').value.trim(),relationship_stage:document.getElementById('newAccountStage').value,owner:currentUser,status:'active'}).select().single();
if(error){alert('Error: '+error.message);return}closeAddAccountModal();loadPortfolio()}
sb.channel('realtime-all').on('postgres_changes',{event:'*',schema:'public',table:'account_sections'},(payload)=>{if(payload.new&&payload.new.account_id===currentAccountId){sections[payload.new.section_type]=payload.new}}).on('postgres_changes',{event:'INSERT',schema:'public',table:'research_updates'},(payload)=>{if(payload.new&&payload.new.account_id===currentAccountId){researchUpdates.unshift(payload.new)}}).subscribe();
loadPortfolio();
</script></body></html>